<!doctype html>
<html lang="en" data-bs-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TactiGraph</title>

    <!-- Favicon (served from /static/) -->
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="shortcut icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='apple-touch-icon.png') }}">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
    <style>
  :root{
    --bg:#f7f9ff;--bg2:#fff;--card:#fff;--card-border:#e9eef7;
    --text:#0f172a;--muted:#667085;--ring:#5184ff;
    --g1:#5ea0ff;--g2:#a37bff;--g3:#ff86b4;
    --chip-bg:#f8fbff;--chip-hover:#eef4ff;--divider:#eef2f7;
    --accent: linear-gradient(135deg,var(--g1),var(--g2) 50%,var(--g3));
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0;font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans";
    color:var(--text);
    background:
      radial-gradient(1200px 700px at 10% -10%, #e9f1ff 0%, transparent 50%),
      radial-gradient(1000px 600px at 100% 0%, #fde7f2 0%, transparent 55%),
      linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
    background-repeat:no-repeat,no-repeat,no-repeat;background-attachment:fixed,fixed,fixed;background-size:1600px 900px,1400px 800px,100% 100%;
    min-height:100dvh;overflow-x:hidden;
  }
  .row>[class^="col"]{min-width:0}
  .appbar{backdrop-filter:saturate(140%) blur(6px);background:
    linear-gradient(180deg,rgba(255,255,255,.85),rgba(255,255,255,.75)),
    radial-gradient(600px 180px at 20% 0%,rgba(94,160,255,.18),transparent 60%),
    radial-gradient(600px 180px at 80% 0%,rgba(255,134,180,.16),transparent 60%);
    border-bottom:1px solid var(--card-border)
  }
  .brand{font-weight:800;letter-spacing:.2px;background:var(--accent);-webkit-background-clip:text;background-clip:text;color:transparent}
  .card{background:var(--card);border:1px solid var(--card-border);overflow:hidden}
  .rounded-4{border-radius:20px!important}.shadow-soft{box-shadow:0 18px 40px rgba(17,24,39,.10)}
  .card-header{background:linear-gradient(180deg,rgba(255,255,255,.96),rgba(255,255,255,.9));border-bottom:1px solid var(--divider)!important}

  /* Bigger graph card header + panel */
  .card-header.graph-head{padding-top:1.25rem;padding-bottom:1rem}
  .graph-title{font-weight:800;letter-spacing:.2px;margin:0;font-size:1.4rem}
  .graph-sub{color:var(--muted);font-size:.875rem}
  .graph-panel{background:#fff;height:400px;position:relative}
  @media (min-width: 992px){.graph-panel{height:400px}}

  .btn-accent{background:var(--accent);color:#fff;border:0;font-weight:700;letter-spacing:.2px;border-radius:14px;padding:10px 16px;box-shadow:0 12px 28px rgba(81,132,255,.25), inset 0 0 0 1px rgba(255,255,255,.55)}
  .btn-accent:hover{filter:brightness(1.05);box-shadow:0 18px 36px rgba(81,132,255,.28), inset 0 0 0 1px rgba(255,255,255,.7)}
  .btn-accent-outline{background:#fff;color:var(--text);border:1px solid var(--chip-hover);border-radius:12px;padding:8px 12px;font-weight:600}

  .btn-chip{background:var(--chip-bg);border:1px dashed var(--chip-hover);color:var(--text);border-radius:999px;padding:.35rem .7rem;font-weight:600}
  .btn-chip:hover{background:var(--chip-hover);border-color:var(--ring)}

  .input-group .form-control{border:1px solid var(--chip-hover);background:#f9fbff;border-right:0;border-radius:12px 0 0 12px}
  .input-group .form-control:focus{box-shadow:0 0 0 4px rgba(81,132,255,.25);border-color:var(--ring);background:#eef4ff}
  .btn-mic{border:1px solid var(--chip-hover);border-left:0;background:#fff;color:var(--text);border-radius:0 12px 12px 0;padding:8px 10px;box-shadow:0 1px 0 rgba(17,24,39,.04)}
  .btn-mic:hover{background:#f9fbff;border-color:var(--ring);box-shadow:0 6px 16px rgba(81,132,255,.18)}
  .btn-mic.listening{border-color:#ff6b81!important;color:#ff3b57!important;animation:pulse 1.1s infinite}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,59,87,.18)}70%{box-shadow:0 0 0 12px rgba(255,59,87,0)}100%{box-shadow:0 0 0 0 rgba(255,59,87,0)}}

  .graph-empty{
    position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    text-align:center;padding:1rem;color:var(--muted);pointer-events:none;
  }
  .small-muted{color:var(--muted)!important}
  .xrange-row { display: none; }

  /* ===== Fancy Recommendations ===== */
  .reco-card{
    position:relative; border-radius:22px; overflow:hidden;
    background:linear-gradient(180deg,rgba(255,255,255,.96),rgba(255,255,255,.96));
    border:1px solid var(--card-border);
    box-shadow:0 18px 40px rgba(17,24,39,.08);
    backdrop-filter:saturate(140%) blur(6px);
  }
  .reco-card::before{ /* gradient edge */
    content:""; position:absolute; inset:0; padding:1px; border-radius:22px;
    background:var(--accent);
    -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
    -webkit-mask-composite:xor; mask-composite:exclude; pointer-events:none;
  }

  .reco-head{
    display:flex; align-items:center; justify-content:space-between; gap:.75rem;
    padding:1.15rem 1.25rem; border-bottom:1px solid var(--divider);
    background:linear-gradient(180deg,rgba(255,255,255,.98),rgba(255,255,255,.9));
  }
  .reco-title{
    display:flex; align-items:center; gap:.6rem; margin:0;
    font-weight:900; letter-spacing:.2px; font-size:1.1rem;
  }
  .reco-badge{
    font-weight:800; font-size:.72rem; letter-spacing:.08em; text-transform:uppercase;
    padding:.25rem .5rem; border-radius:999px; color:#3b4a6b;
    background:#f6f9ff; border:1px solid var(--card-border);
  }
  .reco-actions .btn-mini{
    border:1px solid var(--card-border); background:#fff; font-weight:700;
    border-radius:12px; padding:.45rem .7rem;
  }
  .reco-actions .btn-mini:hover{ border-color:#dfe7fb; box-shadow:0 8px 20px rgba(17,24,39,.08) }

  .reco-body{ padding:1rem 1.1rem 1.25rem }
  .reco-grid{ display:grid; grid-template-columns:repeat(1,minmax(0,1fr)); gap:.9rem }
  @media (min-width:576px){ .reco-grid{ grid-template-columns:repeat(2,minmax(0,1fr)) } }
  @media (min-width:992px){ .reco-grid{ grid-template-columns:repeat(3,minmax(0,1fr)) } }

  /* Tile */
  .reco-tile{
    position:relative; border-radius:16px; overflow:hidden; cursor:pointer;
    border:1px solid var(--card-border); background:#fff;
    transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease;
  }
  .reco-tile:hover{ transform:translateY(-2px); border-color:#e0e7ff; box-shadow:0 14px 28px rgba(17,24,39,.10) }
  .reco-tile::before{ /* subtle gradient corner */
    content:""; position:absolute; inset:-25% -10% auto auto; height:90px;
    background:radial-gradient(120px 90px at 100% 0%, rgba(94,160,255,.18), transparent 60%),
               radial-gradient(120px 90px at 90% 10%, rgba(255,134,180,.16), transparent 60%);
    pointer-events:none;
  }
  .reco-top{ display:flex; align-items:center; justify-content:space-between; padding:.9rem .95rem .35rem }
  .reco-label{ font-weight:800; font-size:.95rem; letter-spacing:.2px }
  .reco-chip{
    font-size:.72rem; border-radius:999px; padding:.15rem .5rem;
    border:1px solid var(--chip-hover); background:#fff; color:#475569
  }
  .reco-expr{
    padding:0 .95rem .85rem; color:#0f172a; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    font-weight:800; letter-spacing:.2px;
  }
  .reco-foot{
    display:flex; align-items:center; justify-content:space-between; gap:.6rem;
    padding:.65rem .85rem; border-top:1px dashed var(--divider); background:#fff;
  }
  .reco-why{ color:var(--muted); font-size:.84rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
  .btn-try{
    border:0; border-radius:12px; font-weight:800; padding:.5rem .75rem; line-height:1;
    background:var(--accent); color:#fff; box-shadow:0 10px 24px rgba(81,132,255,.22);
  }
  .btn-try:hover{ filter:brightness(1.05) }

  /* Loading shimmer */
  .reco-skeleton{
    border-radius:16px; height:92px; background:
     linear-gradient(90deg,#f3f6ff 25%,#eef3ff 37%,#f3f6ff 63%);
    background-size:400% 100%; animation:shimmer 1.1s linear infinite;
    border:1px solid var(--card-border)
  }
  @keyframes shimmer{ 0%{background-position:100% 0} 100%{background-position:-100% 0} }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg appbar sticky-top">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="/">
          <span class="brand">TactiGraph</span>
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navContent" aria-controls="navContent" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div id="navContent" class="collapse navbar-collapse">
          <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-2">
            {% if user %}
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle fw-semibold" href="#" id="userMenu" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  {{ user.username }}
                </a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
                  <li><a class="dropdown-item" href="{{ url_for('logout') }}">Log out</a></li>
                </ul>
              </li>
            {% else %}
              <li class="nav-item">
                <a class="btn btn-sm btn-accent-outline" href="{{ url_for('login') }}">Log in</a>
              </li>
              <li class="nav-item">
                <a class="btn btn-sm btn-accent ms-lg-2 mt-2 mt-lg-0" href="{{ url_for('register') }}">Sign up</a>
              </li>
            {% endif %}
          </ul>
        </div>
      </div>
    </nav>

    <span id="pathStatus" class="small ms-3 small-muted d-none"></span>

    <main class="container py-4 py-lg-3">
      <div class="row g-4 g-lg-5 align-items-start mb-5">
        <!-- Left: Plot settings -->
        <div class="col-12 col-lg-4">
          <div class="card rounded-4 shadow-soft overflow-hidden">
            <div class="card-header px-4 pt-4 d-flex align-items-center justify-content-between">
              <div>
                <h5 class="mb-1 fw-bold">Plot settings</h5>
                <div class="small-muted small">Use <code>x</code> as the variable</div>
              </div>
              <button class="btn btn-sm btn-accent-outline" data-bs-toggle="modal" data-bs-target="#helpModal">Instructions</button>
            </div>
            <div class="card-body p-4">
              <form id="plot-form" class="vstack gap-3" method="post">
                <div>
                  <label class="form-label fw-semibold">y =</label>
                  <div class="input-group">
                    <input id="expr" name="expr" value="{{ expr or 'sin(x)' }}" class="form-control form-control-lg" placeholder="e.g., sin(x) + x^2" required data-speech="true">
                    <button class="btn btn-mic" type="button" aria-label="Dictate equation" title="Dictate">🎤</button>
                  </div>
                </div>

                <div>
                  <label class="form-label fw-semibold">Title (optional)</label>
                  <div class="input-group">
                    <input id="title" name="title" value="{{ title or '' }}" class="form-control" placeholder="My plot" data-speech="true">
                    <button class="btn btn-mic" type="button" aria-label="Dictate title" title="Dictate">🎤</button>
                  </div>
                </div>

                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="grid" id="grid" {% if grid == 'on' or grid is not defined %}checked{% endif %}>
                  <label class="form-check-label" for="grid">Show grid</label>
                </div>

                <!-- Actions: Plot + Send -->
                <div class="d-grid gap-2 d-md-flex">
                  <button class="btn btn-accent btn-lg flex-grow-1" type="submit">Plot</button>
                  <button id="sendBtn" type="button" class="btn btn-accent-outline btn-lg" disabled>
                    Send to TactiRead
                  </button>
                </div>
                <div id="sendStatus" class="small mt-2 small-muted"></div>
              </form>

              <div class="mt-4">
                <div class="small mb-2 small-muted">Presets (click to fill, then press Plot)</div>
                <div class="d-flex flex-wrap gap-2">
                  <button class="btn btn-sm btn-chip preset" data-expr="sin(x)" data-xmin="-10" data-xmax="10">sin(x)</button>
                  <button class="btn btn-sm btn-chip preset" data-expr="x^2" data-xmin="-5" data-xmax="5">x^2</button>
                  <button class="btn btn-sm btn-chip preset" data-expr="exp(x)" data-xmin="-2" data-xmax="2">exp(x)</button>
                  <button class="btn btn-sm btn-chip preset" data-expr="log(x)" data-xmin="0.1" data-xmax="10">log(x)</button>
                  <button class="btn btn-sm btn-chip preset" data-expr="sin(x)/x" data-xmin="-20" data-xmax="20">sin(x)/x</button>
                </div>
                <div class="d-flex flex-wrap gap-2 mt-2">
                  <button class="btn btn-sm btn-chip preset" data-expr="cos(x)" data-xmin="-10" data-xmax="10">cos(x)</button>
                  <button class="btn btn-sm btn-chip preset" data-expr="tan(x)" data-xmin="-5" data-xmax="5">tan(x)</button>
                  <button class="btn btn-sm btn-chip preset" data-expr="sqrt(x)" data-xmin="0" data-xmax="25">sqrt(x)</button>
                  <button class="btn btn-sm btn-chip preset" data-expr="abs(x)" data-xmin="-10" data-xmax="10">abs(x)</button>
                </div>
              </div>

              <div id="srStatus" class="small mt-3 small-muted"></div>
            </div>
          </div>
        </div>

        <!-- Right: Graph on top, Try next below -->
        <div class="col-12 col-lg-8">
          <div class="row g-4">
            <!-- Graph (TOP) -->
            <div class="col-12">
              <div class="card rounded-4 shadow-soft overflow-hidden h-100">
                <div class="card-header graph-head d-flex align-items-center justify-content-between">
                  <div>
                    <h3 class="graph-title">Graph</h3>
                    <div class="graph-sub">High-contrast, larger canvas for easier inspection</div>
                  </div>
                </div>
                <div class="graph-panel">
                  <div id="graphEmpty" class="graph-empty">
                    <div>
                      <div class="mb-1 fw-semibold">Your graph will appear here</div>
                      <div class="small small-muted">Enter an expression (e.g., <code>sin(x)</code>) and click <strong>Plot</strong>.</div>
                    </div>
                  </div>
                  <canvas id="chart"></canvas>
                </div>
                <div class="card-footer bg-white border-0 small px-4 pb-4 small-muted">
                  Tip: Use <code>^</code> for exponent (e.g., <code>x^3</code>). <strong>Click “Plot” to render.</strong>
                  <span id="err" class="text-danger ms-2"></span>
                </div>
              </div>
            </div>

            <!-- Recommendations (BOTTOM) -->
            <div class="col-12">
              <section class="h-100">
                <div class="reco-card h-100">
                  <div class="reco-head">
                    <h6 class="reco-title mb-0">
                      <span class="reco-badge">Try next</span>
                      Explore variations
                    </h6>
                    <div class="reco-actions">
                      <button id="shuffleReco" class="btn-mini" type="button">Shuffle</button>
                      <button id="clearReco" class="btn-mini" type="button">Clear</button>
                    </div>
                  </div>

                  <div class="reco-body">
                    <div id="recoStatus" class="small-muted mb-2"></div>

                    <!-- Loading skeletons -->
                    <div id="recoSkeleton" class="reco-grid d-none">
                      <div class="reco-skeleton"></div>
                      <div class="reco-skeleton"></div>
                      <div class="reco-skeleton"></div>
                    </div>

                    <!-- Tiles injected here -->
                    <div id="recoGrid" class="reco-grid"></div>

                    <!-- Why lines -->
                    <div id="recoWhy" class="small mt-3"></div>
                  </div>
                </div>
              </section>
            </div>

          </div>
        </div>
      </div>
    </main>

    <!-- Instructions Modal -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content rounded-4">
          <div class="modal-header" style="border-color: var(--card-border)!important;">
            <h5 class="modal-title fw-bold" id="helpModalLabel">How to write formulas</h5>
            <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row g-4">
              <div class="col-12 col-lg-6">
                <h6 class="mb-2 fw-bold">Basics</h6>
                <ul class="small mb-3 small-muted">
                  <li>Use variable <code>x</code> only (no other variables, no equal signs).</li>
                  <li>Operators: <code>+</code> <code>-</code> <code>*</code> <code>/</code> <code>^</code> (power), parentheses <code>( )</code>.</li>
                  <li>Implicit multiplication is allowed: <code>2x</code>, <code>x(x+1)</code>, <code>3sin(x)</code>.</li>
                  <li>Constants: <code>pi</code>, <code>E</code>, <code>oo</code>.</li>
                </ul>
              </div>

              <div class="col-12 col-lg-6">
                <h6 class="mb-2 fw-bold">Quick examples</h6>
                <p class="small mb-2 small-muted">Click an example to fill the form, then press <strong>Plot</strong>.</p>
                <div class="d-flex flex-wrap gap-2">
                  <span class="btn btn-sm btn-chip ex" data-expr="sin(x)" data-xmin="-10" data-xmax="10">sin(x)</span>
                  <span class="btn btn-sm btn-chip ex" data-expr="x^3 - 2*x" data-xmin="-4" data-xmax="4">x^3 - 2x</span>
                  <span class="btn btn-sm btn-chip ex" data-expr="exp(x)" data-xmin="-2" data-xmax="2">exp(x)</span>
                  <span class="btn btn-sm btn-chip ex" data-expr="log(x)" data-xmin="0.1" data-xmax="10">log(x)</span>
                  <span class="btn btn-sm btn-chip ex" data-expr="sin(x)/x" data-xmin="-20" data-xmax="20">sin(x)/x</span>
                  <span class="btn btn-sm btn-chip ex" data-expr="abs(x)" data-xmin="-10" data-xmax="10">abs(x)</span>
                  <span class="btn btn-sm btn-chip ex" data-expr="sqrt(x)" data-xmin="0" data-xmax="25">sqrt(x)</span>
                  <span class="btn btn-sm btn-chip ex" data-expr="sin(x)+cos(2x)" data-xmin="-10" data-xmax="10">sin(x)+cos(2x)</span>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer" style="border-color: var(--card-border)!important;">
            <button class="btn btn-accent-outline" data-bs-dismiss="modal">Close</button>
            <button class="btn btn-accent" data-bs-dismiss="modal" id="trySelected">Use first example</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
  // ------------------ Config ------------------
  // Chart sampling (wide for smooth curves)
  const DATA_XMIN = -60;
  const DATA_XMAX =  60;

  // On-screen view window (tight)
  const VIEW_XMIN = -20;
  const VIEW_XMAX =  20;

  // Fixed world bounds for /coords (metadata only for most backends)
  const PATH_XMIN = -50;
  const PATH_XMAX =  50;
  const PATH_YMIN = -100;
  const PATH_YMAX =  100;

  // Device grid step to use with /coords (50-step granularity)
  const STEP_FOR_COORDS = 50;

  // ------------------ DOM refs ------------------
  const form  = document.getElementById('plot-form');
  const expr  = document.getElementById('expr');
  const title = document.getElementById('title');
  const grid  = document.getElementById('grid');
  const errEl = document.getElementById('err');
  const pathStatus = document.getElementById('pathStatus');

  const sendBtn    = document.getElementById('sendBtn');
  const sendStatus = document.getElementById('sendStatus');
  function setSendEnabled(enabled){ if(sendBtn) sendBtn.disabled = !enabled; }
  function setSendStatus(text){ if(sendStatus) sendStatus.textContent = text || ''; }

  let hasPlotted = false;
  let lastPlot = null;

  // ------------------ Chart ------------------
  const ctx = document.getElementById('chart');
  const chart = new Chart(ctx, {
    type: 'line',
    data: { datasets: [{ label: 'y(x)', data: [], fill: false, tension: 0.15, borderWidth: 2, pointRadius: 0 }] },
    options: {
      responsive: true, maintainAspectRatio: false, animation: false,
      scales: {
        x: { type: 'linear', title: { display: true, text: 'x' }, grid: { display: false },
             ticks: { stepSize: 1, callback: v => Number.isInteger(v) ? v : '' }, bounds: 'ticks',
             min: VIEW_XMIN, max: VIEW_XMAX },
        y: { title: { display: true, text: 'y' }, grid: { display: false } }
      },
      plugins: { legend: { display: false }, title: { display: true, text: '' }, tooltip: { mode: 'index', intersect: false } },
      elements: { line: { spanGaps: true } }
    }
  });

  const graphEmpty = document.getElementById('graphEmpty');
  const showGraphEmpty = (show) => { if (graphEmpty) graphEmpty.style.display = show ? 'flex' : 'none'; };
  showGraphEmpty(true);
  if (pathStatus) pathStatus.textContent = 'No plot yet — enter an expression and click Plot.';

  function applyGrid() {
    const show = grid.checked;
    chart.options.scales.x.grid.display = show;
    chart.options.scales.y.grid.display = show;
  }

  // ------------------ API helpers ------------------
  function dataUrl() {
    const params = new URLSearchParams({
      expr: expr.value || 'sin(x)',
      xmin: String(DATA_XMIN),
      xmax: String(DATA_XMAX)
    });
    params.set('_', Date.now().toString());
    return `/data?${params.toString()}`;
  }

  // Always include step=STEP_FOR_COORDS so backend uses 50-step ticks
  function coordsUrl(exprValue, opts = {}) {
    const params = new URLSearchParams({
      expr: exprValue,
      xmin: String(PATH_XMIN),
      xmax: String(PATH_XMAX),
      ymin: String(PATH_YMIN),
      ymax: String(PATH_YMAX),
      step: String(STEP_FOR_COORDS)   // <<<<<<<<<<<<<<<<<<<<<<<<<< important
    });
    if (opts.print) params.set('print', '1');
    if (opts.send)  params.set('send',  '1');
    params.set('_', Date.now().toString());
    return `/coords?${params.toString()}`;
  }

  // ------------------ Plot flow ------------------
  async function updateChart() {
    if (errEl) errEl.textContent = '';
    if (pathStatus) pathStatus.textContent = 'Plotting…';

    try {
      // 1) Plot sampled points for the on-screen chart
      const res = await fetch(dataUrl());
      const payload = await res.json();
      if (!res.ok) throw new Error(payload.error || 'Unknown error');

      const points = payload.x.map((xi, i) => ({ x: xi, y: payload.y[i] }));
      chart.data.datasets[0].data = points;
      chart.options.scales.x.min = VIEW_XMIN;
      chart.options.scales.x.max = VIEW_XMAX;
      chart.options.plugins.title.text = title.value ? title.value : `y = ${payload.expr}`;
      applyGrid();
      chart.update();

      showGraphEmpty(false);
      hasPlotted = true;

      // 2) Save context for "Send"
      lastPlot = { expr: payload.expr };
      setSendEnabled(true);
      setSendStatus('');

      // 3) Ask backend to compute integer cells (print only)
      const cRes = await fetch(coordsUrl(payload.expr, { print: true }));
      const cPayload = await cRes.json();
      if (!cRes.ok) throw new Error(cPayload.error || 'Path generation failed');

      if (pathStatus) {
        const n = (cPayload?.cells?.length ?? 0);
        pathStatus.textContent = `Path prepared (${n} cells @ step=${STEP_FOR_COORDS})`;
        setTimeout(() => { if (pathStatus.textContent.includes('Path prepared')) pathStatus.textContent = ''; }, 3000);
      }

      // 4) Recommendations
      await fetchRecommendations();

    } catch (e) {
      if (errEl) errEl.textContent = e.message;
      chart.data.datasets[0].data = [];
      chart.options.plugins.title.text = 'Error';
      chart.update();
      showGraphEmpty(true);
      hasPlotted = false;
      lastPlot = null;
      setSendEnabled(false);
      setSendStatus('');
      if (pathStatus) pathStatus.textContent = 'Could not plot. Check your expression.';
    }
  }

  // ------------------ Send to device ------------------
  sendBtn?.addEventListener('click', async () => {
    if (!lastPlot) { setSendStatus('Plot something first.'); return; }

    try {
      setSendEnabled(false);
      setSendStatus('Sending to Arduino…');

      const res = await fetch(coordsUrl(lastPlot.expr, { send: true }));
      const payload = await res.json();
      if (!res.ok) throw new Error(payload.error || 'Send failed.');

      const msg = payload.send_status || `Sent ${(payload?.cells?.length ?? 0)} cells @ step=${STEP_FOR_COORDS}.`;
      setSendStatus(msg);
    } catch (e) {
      setSendStatus(`Error: ${e.message}`);
    } finally {
      setSendEnabled(true);
    }
  });

  // ------------------ Presets / examples ------------------
  document.querySelectorAll('.preset').forEach(btn => {
    btn.addEventListener('click', () => {
      expr.value = btn.dataset.expr;
      title.value = '';
      grid.checked = true;
      if (pathStatus) pathStatus.textContent = 'Preset loaded — click Plot.';
    });
  });
  document.querySelectorAll('.ex').forEach(chip => {
    chip.addEventListener('click', () => {
      expr.value = chip.dataset.expr;
      title.value = '';
      grid.checked = true;
      const help = bootstrap.Modal.getInstance(document.getElementById('helpModal'));
      if (help) help.hide();
      if (pathStatus) pathStatus.textContent = 'Example loaded — click Plot.';
    });
  });
  document.getElementById('trySelected')?.addEventListener('click', () => {
    document.querySelector('.ex')?.click();
  });
  form.addEventListener('submit', (e) => { e.preventDefault(); updateChart(); });

  // ------------------ Web Speech (optional) ------------------
  (function () {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    const statusEl = document.getElementById('srStatus');

    if (!SR) {
      if (statusEl) statusEl.textContent = 'Speech recognition not supported in this browser.';
      document.querySelectorAll('.btn-mic').forEach(btn => {
        btn.disabled = true;
        btn.title = 'Speech recognition not supported in this browser.';
      });
      return;
    }

    let recognition = null;
    let activeBtn = null;
    let activeInput = null;

    function startRecognition(forInput, btn) {
      stopRecognition();
      recognition = new SR();
      recognition.lang = navigator.language || 'en-US';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      activeBtn = btn;
      activeInput = forInput;

      btn.classList.add('listening');
      if (statusEl) statusEl.textContent = 'Listening…';

      recognition.onresult = (event) => {
        const transcript = (event.results[0]?.[0]?.transcript) || '';
        activeInput.value = transcript;
        if (activeInput.id === 'expr') setTimeout(() => updateChart(), 50);
      };
      recognition.onerror = (e) => { if (statusEl) statusEl.textContent = 'Speech error: ' + (e.error || 'unknown'); };
      recognition.onend = () => {
        btn.classList.remove('listening');
        if (statusEl) statusEl.textContent = '';
        recognition = null; activeBtn = null; activeInput = null;
      };

      try { recognition.start(); } catch (_) {}
    }

    function stopRecognition() {
      if (recognition) { try { recognition.stop(); } catch (_) {} recognition = null; }
      if (activeBtn) activeBtn.classList.remove('listening');
      const statusEl2 = document.getElementById('srStatus');
      if (statusEl2) statusEl2.textContent = '';
    }

    document.querySelectorAll('input[data-speech="true"]').forEach((inputEl) => {
      const micBtn = inputEl.parentElement?.querySelector('.btn-mic');
      if (!micBtn) return;
      micBtn.addEventListener('click', () => {
        if (micBtn.classList.contains('listening')) stopRecognition();
        else startRecognition(inputEl, micBtn);
      });
      inputEl.addEventListener('keydown', (e) => { if (e.key === 'Escape') stopRecognition(); });
    });

    form?.addEventListener('submit', () => stopRecognition());
  })();

  // ------------------ Recommendations (fancy) ------------------
  const recoGrid     = document.getElementById('recoGrid');
  const recoWhy      = document.getElementById('recoWhy');
  const recoStatus   = document.getElementById('recoStatus');
  const recoSkeleton = document.getElementById('recoSkeleton');
  const btnShuffle   = document.getElementById('shuffleReco');
  const btnClear     = document.getElementById('clearReco');

  function setRecoLoading(loading){
    if (!recoStatus || !recoSkeleton) return;
    recoStatus.innerHTML = loading
      ? '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Finding ideas…'
      : '';
    recoSkeleton.classList.toggle('d-none', !loading);
  }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  function renderRecommendations(list){
    if (!recoGrid || !recoWhy) return;
    recoGrid.innerHTML = ''; recoWhy.innerHTML = '';

    if (!hasPlotted){
      recoGrid.innerHTML = `<div class="small text-muted">Plot something to get smart suggestions. Try: <code>sin(x)</code>, <code>x^2</code>, or <code>sin(x)/x</code>.</div>`;
      return;
    }
    if (!list?.length){
      recoGrid.innerHTML = `<div class="small text-muted">No suggestions yet. Quick tweaks: <code>x+1</code>, <code>2*x</code>, <code>x^2</code>, <code>sin(x)</code>.</div>`;
      return;
    }

    list.forEach((s, idx) => {
      const label = s.label || 'Variation';
      const why   = s.why   || '';
      const exprS = s.expr  || expr.value;

      const tile = document.createElement('div');
      tile.className = 'reco-tile';
      tile.innerHTML = `
        <div class="reco-top">
          <div class="reco-label">${escapeHtml(label)}</div>
          <span class="reco-chip">${idx+1 < 10 ? '0'+(idx+1) : idx+1}</span>
        </div>
        <div class="reco-expr"><code>${escapeHtml(exprS)}</code></div>
        <div class="reco-foot">
          <div class="reco-why">${escapeHtml(why)}</div>
          <button class="btn-try reco-try" type="button">Try it</button>
        </div>
      `;

      tile.addEventListener('click', (e) => {
        if (e.target && e.target.classList.contains('reco-try')) return;
        expr.value = exprS; title.value = label; updateChart();
      });
      tile.querySelector('.reco-try')?.addEventListener('click', () => {
        expr.value = exprS; title.value = label; updateChart();
      });

      recoGrid.appendChild(tile);
    });

    recoWhy.innerHTML = list.map(s => `• <strong>${escapeHtml(s.expr||'')}</strong>: ${escapeHtml(s.why||'')}`).join('<br/>');
  }

  async function fetchRecommendations(){
    try{
      setRecoLoading(true);
      const res = await fetch('/recommend', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ expr: expr.value || 'sin(x)', xmin: DATA_XMIN, xmax: DATA_XMAX, title: title.value || '' })
      });
      const payload = await res.json();
      renderRecommendations(payload.suggestions || []);
    } catch{
      renderRecommendations([]);
    } finally{
      setRecoLoading(false);
    }
  }
  renderRecommendations([]);

  // Controls
  btnShuffle?.addEventListener('click', async () => {
    setRecoLoading(true);
    try{
      await fetchRecommendations(); // request fresh set server-side (or shuffle client-side)
    } finally{
      setRecoLoading(false);
    }
  });
  btnClear?.addEventListener('click', () => {
    recoGrid.innerHTML = '';
    recoWhy.textContent = '';
    recoStatus.textContent = '';
  });
    </script>

  </body>
</html>
