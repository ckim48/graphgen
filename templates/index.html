<!doctype html>
<html lang="en" data-bs-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Equation Grapher</title>

    <!-- Favicon (served from /static/) -->
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="shortcut icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='apple-touch-icon.png') }}">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
    <style>
      :root{
        --bg:#f7f9ff;--bg2:#fff;--card:#fff;--card-border:#e9eef7;
        --text:#0f172a;--muted:#667085;--ring:#5184ff;
        --g1:#5ea0ff;--g2:#a37bff;--g3:#ff86b4;
        --field-bg:#f3f6ff;--field-border:#e2e8f0;--field-focus:rgba(81,132,255,.25);
        --chip-bg:#f8fbff;--chip-hover:#eef4ff;--divider:#eef2f7;
      }
      *{box-sizing:border-box} html,body{height:100%}
      body{
        margin:0;font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans";
        color:var(--text);
        background:
          radial-gradient(1200px 700px at 10% -10%, #e9f1ff 0%, transparent 50%),
          radial-gradient(1000px 600px at 100% 0%, #fde7f2 0%, transparent 55%),
          linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
        background-repeat:no-repeat,no-repeat,no-repeat;background-attachment:fixed,fixed,fixed;background-size:1600px 900px,1400px 800px,100% 100%;
        min-height:100dvh;overflow-x:hidden;
      }
      .row>[class^="col"]{min-width:0}
      .appbar{backdrop-filter:saturate(140%) blur(6px);background:linear-gradient(180deg,rgba(255,255,255,.85),rgba(255,255,255,.75)),radial-gradient(600px 180px at 20% 0%,rgba(94,160,255,.18),transparent 60%),radial-gradient(600px 180px at 80% 0%,rgba(255,134,180,.16),transparent 60%);border-bottom:1px solid var(--card-border)}
      .brand{font-weight:800;letter-spacing:.2px;background:linear-gradient(135deg,var(--g1),var(--g2) 50%,var(--g3));-webkit-background-clip:text;background-clip:text;color:transparent}
      .brand-logo{width:26px;height:26px;border-radius:6px;object-fit:contain;margin-right:.5rem}
      .card{background:var(--card);border:1px solid var(--card-border);overflow:hidden}
      .rounded-4{border-radius:20px!important}.shadow-soft{box-shadow:0 18px 40px rgba(17,24,39,.10)}
      .card-header{background:linear-gradient(180deg,rgba(255,255,255,.96),rgba(255,255,255,.9));border-bottom:1px solid var(--divider)!important}
      .btn-accent{background:linear-gradient(135deg,var(--g1),var(--g2) 50%,var(--g3));color:#fff;border:0;font-weight:700;letter-spacing:.2px;border-radius:14px;padding:10px 16px;box-shadow:0 12px 28px rgba(81,132,255,.25), inset 0 0 0 1px rgba(255,255,255,.55)}
      .btn-accent:hover{filter:brightness(1.05);box-shadow:0 18px 36px rgba(81,132,255,.28), inset 0 0 0 1px rgba(255,255,255,.7)}
      .btn-accent-outline{background:#fff;color:var(--text);border:1px solid var(--field-border);border-radius:12px;padding:8px 12px;font-weight:600}
      .btn-chip{background:var(--chip-bg);border:1px dashed var(--field-border);color:var(--text);border-radius:999px;padding:.35rem .7rem;font-weight:600}
      .btn-chip:hover{background:var(--chip-hover);border-color:var(--ring)}
      .input-group .form-control{border:1px solid var(--field-border);background:var(--field-bg);border-right:0;border-radius:12px 0 0 12px}
      .input-group .form-control:focus{box-shadow:0 0 0 4px var(--field-focus);border-color:var(--ring);background:#eef4ff}
      .btn-mic{border:1px solid var(--field-border);border-left:0;background:#fff;color:var(--text);border-radius:0 12px 12px 0;padding:8px 10px;box-shadow:0 1px 0 rgba(17,24,39,.04)}
      .btn-mic:hover{background:#f9fbff;border-color:var(--ring);box-shadow:0 6px 16px rgba(81,132,255,.18)}
      .btn-mic.listening{border-color:#ff6b81!important;color:#ff3b57!important;animation:pulse 1.1s infinite}
      @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,59,87,.18)}70%{box-shadow:0 0 0 12px rgba(255,59,87,0)}100%{box-shadow:0 0 0 0 rgba(255,59,87,0)}}
      .reco-chip{background:var(--chip-bg);border:1px solid var(--field-border);border-radius:999px;padding:.45rem .8rem;cursor:pointer;font-weight:700;font-size:.95rem}
      .reco-note{background:#fff;border:1px dashed var(--field-border);border-radius:14px;padding:.65rem .8rem}
      .graph-panel{background:#fff;height:340px;position:relative}
      @media (min-width: 992px){.graph-panel{height:340px}}
      .graph-empty{
        position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
        text-align:center;padding:1rem;color:var(--muted);pointer-events:none;
      }
      .small-muted{color:var(--muted)!important}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg appbar sticky-top">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="/">
          <span class="brand">Equation Grapher</span>
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navContent" aria-controls="navContent" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div id="navContent" class="collapse navbar-collapse">
          <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-2">
            {% if user %}
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle fw-semibold" href="#" id="userMenu" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  {{ user.username }}
                </a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
                  <li><a class="dropdown-item" href="{{ url_for('logout') }}">Log out</a></li>
                </ul>
              </li>
            {% else %}
              <li class="nav-item">
                <a class="btn btn-sm btn-accent-outline" href="{{ url_for('login') }}">Log in</a>
              </li>
              <li class="nav-item">
                <a class="btn btn-sm btn-accent ms-lg-2 mt-2 mt-lg-0" href="{{ url_for('register') }}">Sign up</a>
              </li>
            {% endif %}
          </ul>
        </div>
      </div>
    </nav>

    <span id="pathStatus" class="small ms-3 small-muted d-none"></span>

    <main class="container py-4 py-lg-3">
      <div class="row g-4 g-lg-5 align-items-start mb-5">
        <!-- Left: Plot settings -->
        <div class="col-12 col-lg-4">
          <div class="card rounded-4 shadow-soft overflow-hidden">
            <div class="card-header px-4 pt-4 d-flex align-items-center justify-content-between">
              <div>
                <h5 class="mb-1 fw-bold">Plot settings</h5>
                <div class="small-muted small">Use <code>x</code> as the variable</div>
              </div>
              <button class="btn btn-sm btn-accent-outline" data-bs-toggle="modal" data-bs-target="#helpModal">Instructions</button>
            </div>
            <div class="card-body p-4">
              <form id="plot-form" class="vstack gap-3" method="post">
                <div>
                  <label class="form-label fw-semibold">y =</label>
                  <div class="input-group">
                    <input id="expr" name="expr" value="{{ expr or 'sin(x)' }}" class="form-control form-control-lg" placeholder="e.g., sin(x) + x^2" required data-speech="true">
                    <button class="btn btn-mic" type="button" aria-label="Dictate equation" title="Dictate">🎤</button>
                  </div>
                </div>

                <div class="row g-2">
                  <div class="col">
                    <label class="form-label fw-semibold">x min</label>
                    <div class="input-group">
                      <input id="xmin" name="xmin" value="{{ xmin or '-10' }}" class="form-control" placeholder="-10" required data-speech="true">
                      <button class="btn btn-mic" type="button" aria-label="Dictate x min" title="Dictate">🎤</button>
                    </div>
                  </div>
                  <div class="col">
                    <label class="form-label fw-semibold">x max</label>
                    <div class="input-group">
                      <input id="xmax" name="xmax" value="{{ xmax or '10' }}" class="form-control" placeholder="10" required data-speech="true">
                      <button class="btn btn-mic" type="button" aria-label="Dictate x max" title="Dictate">🎤</button>
                    </div>
                  </div>
                </div>

                <div>
                  <label class="form-label fw-semibold">Title (optional)</label>
                  <div class="input-group">
                    <input id="title" name="title" value="{{ title or '' }}" class="form-control" placeholder="My plot" data-speech="true">
                    <button class="btn btn-mic" type="button" aria-label="Dictate title" title="Dictate">🎤</button>
                  </div>
                </div>

                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="grid" id="grid" {% if grid == 'on' or grid is not defined %}checked{% endif %}>
                  <label class="form-check-label" for="grid">Show grid</label>
                </div>

                <div class="d-grid">
                  <button class="btn btn-accent btn-lg" type="submit">Plot</button>
                </div>
              </form>

              <div class="mt-4">
                <div class="small mb-2 small-muted">Presets (click to fill, then press Plot)</div>
                <div class="d-flex flex-wrap gap-2">
                  <button class="btn btn-sm btn-chip preset" data-expr="sin(x)" data-xmin="-10" data-xmax="10">sin(x)</button>
                  <button class="btn btn-sm btn-chip preset" data-expr="x^2" data-xmin="-5" data-xmax="5">x^2</button>
                  <button class="btn btn-sm btn-chip preset" data-expr="exp(x)" data-xmin="-2" data-xmax="2">exp(x)</button>
                  <button class="btn btn-sm btn-chip preset" data-expr="log(x)" data-xmin="0.1" data-xmax="10">log(x)</button>
                  <button class="btn btn-sm btn-chip preset" data-expr="sin(x)/x" data-xmin="-20" data-xmax="20">sinc</button>
                </div>
              </div>

              <div id="srStatus" class="small mt-3 small-muted"></div>
            </div>
          </div>
        </div>

        <!-- Right: Graph on top, Try next below -->
        <div class="col-12 col-lg-8">
          <div class="row g-4">
            <!-- Graph (TOP) -->
            <div class="col-12">
              <div class="card rounded-4 shadow-soft overflow-hidden h-100">
                <div class="card-header px-4 pt-4 d-flex align-items-center justify-content-between">
                  <h5 class="mb-0 fw-bold">Graph</h5>
                </div>
                <div class="graph-panel">
                  <!-- Empty-state overlay -->
                  <div id="graphEmpty" class="graph-empty">
                    <div>
                      <div class="mb-1 fw-semibold">Your graph will appear here</div>
                      <div class="small small-muted">Enter an expression (e.g., <code>sin(x)</code>) and click <strong>Plot</strong>, or use a preset.</div>
                    </div>
                  </div>
                  <canvas id="chart"></canvas>
                </div>
                <div class="card-footer bg-white border-0 small px-4 pb-4 small-muted">
                  Tip: Use <code>^</code> for exponent (e.g., <code>x^3</code>). <strong>Click “Plot” to render.</strong>
                  <span id="err" class="text-danger ms-2"></span>
                </div>
              </div>
            </div>

            <!-- Recommendations (BOTTOM) -->
            <div class="col-12">
              <section class="h-100">
                <div class="card rounded-4 shadow-soft h-100">
                  <div class="card-header px-4 pt-4 d-flex align-items-center justify-content-between">
                    <h6 class="mb-0 fw-bold">Try next</h6>
                    <small id="recoStatus" class="small-muted"></small>
                  </div>
                  <div class="card-body pt-3 pb-4 px-4 d-flex flex-column">
                    <div id="recoChips" class="d-flex flex-wrap gap-2"></div>
                    <div id="recoWhy" class="small small-muted mt-3"></div>
                  </div>
                </div>
              </section>
            </div>

          </div>
        </div>
      </div>
    </main>

    <!-- Instructions Modal -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content rounded-4">
          <div class="modal-header" style="border-color: var(--card-border)!important;">
            <h5 class="modal-title fw-bold" id="helpModalLabel">How to write formulas</h5>
            <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row g-4">
              <div class="col-12 col-lg-6">
                <h6 class="mb-2 fw-bold">Basics</h6>
                <ul class="small mb-3 small-muted">
                  <li>Use variable <code>x</code> only (no other variables, no equal signs).</li>
                  <li>Operators: <code>+</code> <code>-</code> <code>*</code> <code>/</code> <code>^</code> (power), parentheses <code>( )</code>.</li>
                  <li>Implicit multiplication is allowed: <code>2x</code>, <code>x(x+1)</code>, <code>3sin(x)</code>.</li>
                  <li>Constants: <code>pi</code>, <code>E</code>, <code>oo</code>.</li>
                </ul>
              </div>

              <div class="col-12 col-lg-6">
                <h6 class="mb-2 fw-bold">Quick examples</h6>
                <p class="small mb-2 small-muted">Click an example to fill the form, then press <strong>Plot</strong>.</p>
                <div class="d-flex flex-wrap gap-2">
                  <span class="btn btn-sm btn-chip ex" data-expr="sin(x)" data-xmin="-10" data-xmax="10">sin(x)</span>
                  <span class="btn btn-sm btn-chip ex" data-expr="x^3 - 2*x" data-xmin="-4" data-xmax="4">x^3 - 2x</span>
                  <span class="btn btn-sm btn-chip ex" data-expr="exp(x)" data-xmin="-2" data-xmax="2">exp(x)</span>
                  <span class="btn btn-sm btn-chip ex" data-expr="log(x)" data-xmin="0.1" data-xmax="10">log(x)</span>
                  <span class="btn btn-sm btn-chip ex" data-expr="sin(x)/x" data-xmin="-20" data-xmax="20">sin(x)/x</span>
                  <span class="btn btn-sm btn-chip ex" data-expr="abs(x)" data-xmin="-10" data-xmax="10">abs(x)</span>
                  <span class="btn btn-sm btn-chip ex" data-expr="sqrt(x)" data-xmin="0" data-xmax="25">sqrt(x)</span>
                  <span class="btn btn-sm btn-chip ex" data-expr="sin(x)+cos(2x)" data-xmin="-10" data-xmax="10">sin(x)+cos(2x)</span>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer" style="border-color: var(--card-border)!important;">
            <button class="btn btn-accent-outline" data-bs-dismiss="modal">Close</button>
            <button class="btn btn-accent" data-bs-dismiss="modal" id="trySelected">Use first example</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const form  = document.getElementById('plot-form');
      const expr  = document.getElementById('expr');
      const xmin  = document.getElementById('xmin');
      const xmax  = document.getElementById('xmax');
      const title = document.getElementById('title');
      const grid  = document.getElementById('grid');
      const errEl = document.getElementById('err');
      const pathStatus = document.getElementById('pathStatus');

      // Track if we've plotted successfully at least once
      let hasPlotted = false;

      const ctx = document.getElementById('chart');
      const chart = new Chart(ctx, {
        type: 'line',
        data: { datasets: [{ label: 'y(x)', data: [], fill: false, tension: 0.15, borderWidth: 2, pointRadius: 0 }] },
        options: {
          responsive: true, maintainAspectRatio: false, animation: false,
          scales: {
            x: { type: 'linear', title: { display: true, text: 'x' }, grid: { display: false },
                 ticks: { stepSize: 1, callback: v => Number.isInteger(v) ? v : '' }, bounds: 'ticks' },
            y: { title: { display: true, text: 'y' }, grid: { display: false } }
          },
          plugins: { legend: { display: false }, title: { display: true, text: '' }, tooltip: { mode: 'index', intersect: false } },
          elements: { line: { spanGaps: true } }
        }
      });

      // Empty overlay helpers
      const graphEmpty = document.getElementById('graphEmpty');
      function showGraphEmpty(show) {
        if (!graphEmpty) return;
        graphEmpty.style.display = show ? 'flex' : 'none';
      }
      // Start with overlay visible
      showGraphEmpty(true);
      if (pathStatus) pathStatus.textContent = 'No plot yet — enter an expression and click Plot.';

      function applyGrid() {
        const show = grid.checked;
        chart.options.scales.x.grid.display = show;
        chart.options.scales.y.grid.display = show;
      }

      function dataUrl() {
        const params = new URLSearchParams({
          expr: expr.value || 'sin(x)',
          xmin: xmin.value || '-10',
          xmax: xmax.value || '10'
        });
        params.set('_', Date.now().toString());
        return `/data?${params.toString()}`;
      }

      function pathUrl(exprValue, xminNum, xmaxNum, yminNum, ymaxNum, q=10) {
        const params = new URLSearchParams({
          expr: exprValue, xmin: String(xminNum), xmax: String(xmaxNum),
          ymin: String(yminNum), ymax: String(ymaxNum), q: String(q), print: "1"
        });
        params.set('_', Date.now().toString());
        return `/path?${params.toString()}`;
      }

      async function updateChart() {
        if (errEl) errEl.textContent = '';
        if (pathStatus) pathStatus.textContent = 'Plotting…';

        try {
          // 1) Get sampled points
          const res = await fetch(dataUrl());
          const payload = await res.json();
          if (!res.ok) throw new Error(payload.error || 'Unknown error');

          const xminNum = parseFloat(xmin.value || '-10');
          const xmaxNum = parseFloat(xmax.value || '10');

          const points = payload.x.map((xi, i) => ({ x: xi, y: payload.y[i] }));
          chart.data.datasets[0].data = points;
          chart.options.scales.x.min = xminNum;
          chart.options.scales.x.max = xmaxNum;

          chart.options.plugins.title.text = title.value ? title.value : `y = ${payload.expr}`;
          applyGrid();
          chart.update();

          // Hide empty overlay now that we have a plot
          showGraphEmpty(false);
          hasPlotted = true;

          // 2) Compute y-range for /path
          const finiteYs = (payload.y || []).filter(v => Number.isFinite(v));
          let yminNum = -10, ymaxNum = 10;
          if (finiteYs.length > 0) {
            const minY = Math.min(...finiteYs);
            const maxY = Math.max(...finiteYs);
            const pad = (maxY - minY) * 0.05 || 1;
            yminNum = minY - pad;
            ymaxNum = maxY + pad;
          }

          // 3) Send to /path (prints to console)
          const pathRes = await fetch(pathUrl(payload.expr, xminNum, xmaxNum, yminNum, ymaxNum, 10));
          const pathPayload = await pathRes.json();
          if (!pathRes.ok) throw new Error(pathPayload.error || 'Path generation failed');

          if (pathStatus) {
            pathStatus.textContent = `Path sent to console (${pathPayload.path?.length ?? 0} points)`;
            setTimeout(() => { if (pathStatus.textContent.includes('Path sent')) pathStatus.textContent = ''; }, 3000);
          }

          // 4) Fetch GPT recommendations (populate chips only; DO NOT change the graph)
          await fetchRecommendations();

        } catch (e) {
          if (errEl) errEl.textContent = e.message;
          chart.data.datasets[0].data = [];
          chart.options.plugins.title.text = 'Error';
          chart.update();
          showGraphEmpty(true);
          hasPlotted = false;
          if (pathStatus) pathStatus.textContent = 'Could not plot. Check your expression and range.';
        }
      }

      // Presets just fill fields
      document.querySelectorAll('.preset').forEach(btn => {
        btn.addEventListener('click', () => {
          expr.value = btn.dataset.expr;
          xmin.value = btn.dataset.xmin;
          xmax.value = btn.dataset.xmax;
          title.value = '';
          grid.checked = true;
          if (pathStatus) pathStatus.textContent = 'Preset loaded — click Plot.';
        });
      });

      // Example chips: fill + close modal
      document.querySelectorAll('.ex').forEach(chip => {
        chip.addEventListener('click', () => {
          expr.value = chip.dataset.expr;
          xmin.value = chip.dataset.xmin;
          xmax.value = chip.dataset.xmax;
          title.value = '';
          grid.checked = true;
          const help = bootstrap.Modal.getInstance(document.getElementById('helpModal'));
          if (help) help.hide();
          if (pathStatus) pathStatus.textContent = 'Example loaded — click Plot.';
        });
      });

      // Footer helper
      document.getElementById('trySelected')?.addEventListener('click', () => {
        document.querySelector('.ex')?.click();
      });

      // Plot on submit
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        updateChart();
      });

      // -------- Web Speech API --------
      (function () {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        const statusEl = document.getElementById('srStatus');

        if (!SR) {
          if (statusEl) statusEl.textContent = 'Speech recognition not supported in this browser.';
          document.querySelectorAll('.btn-mic').forEach(btn => {
            btn.disabled = true;
            btn.title = 'Speech recognition not supported in this browser.';
          });
          return;
        }

        let recognition = null;
        let activeBtn = null;
        let activeInput = null;

        function startRecognition(forInput, btn) {
          stopRecognition();
          recognition = new SR();
          recognition.lang = navigator.language || 'en-US';
          recognition.interimResults = false;
          recognition.maxAlternatives = 1;
          activeBtn = btn;
          activeInput = forInput;

          btn.classList.add('listening');
          if (statusEl) statusEl.textContent = 'Listening…';

          recognition.onresult = async (event) => {
            const transcript = (event.results[0]?.[0]?.transcript) || '';
            activeInput.value = transcript;
            if (activeInput.id === 'expr') {
              setTimeout(() => updateChart(), 50);
            }
          };

          recognition.onerror = (e) => {
            if (statusEl) statusEl.textContent = 'Speech error: ' + (e.error || 'unknown');
          };

          recognition.onend = () => {
            btn.classList.remove('listening');
            if (statusEl) statusEl.textContent = '';
            recognition = null;
            activeBtn = null;
            activeInput = null;
          };

          try { recognition.start(); } catch (_) {}
        }

        function stopRecognition() {
          if (recognition) { try { recognition.stop(); } catch (_) {} recognition = null; }
          if (activeBtn) activeBtn.classList.remove('listening');
          const statusEl = document.getElementById('srStatus');
          if (statusEl) statusEl.textContent = '';
        }

        document.querySelectorAll('input[data-speech="true"]').forEach((inputEl) => {
          const micBtn = inputEl.parentElement?.querySelector('.btn-mic');
          if (!micBtn) return;

          micBtn.addEventListener('click', () => {
            if (micBtn.classList.contains('listening')) stopRecognition();
            else startRecognition(inputEl, micBtn);
          });

          inputEl.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') stopRecognition();
          });
        });

        form?.addEventListener('submit', () => stopRecognition());
      })();

      // -------- Recommendations (OpenAI) --------
      const recoChips  = document.getElementById('recoChips');
      const recoWhy    = document.getElementById('recoWhy');
      const recoStatus = document.getElementById('recoStatus');

      // Spinner while loading
      function setRecoLoading(loading) {
        if (!recoStatus) return;
        if (loading) {
          recoStatus.innerHTML =
            '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Finding ideas…';
        } else {
          recoStatus.textContent = '';
        }
      }

      function escapeHtml(s){
        return String(s).replace(/[&<>"']/g, m => (
          { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' }[m]
        ));
      }

      function renderRecommendations(list) {
        recoChips.innerHTML = '';
        recoWhy.innerHTML = '';

        // If nothing has been plotted yet, guide the user
        if (!hasPlotted) {
          recoChips.innerHTML = `
            <div class="text-muted small">
              Plot something to get smart suggestions. Try: <code>sin(x)</code>, <code>x**2</code>, or <code>x+1</code>.
            </div>`;
          return;
        }

        if (!list || !list.length) {
          // Friendly default after plotting if API returns nothing
          recoChips.innerHTML = `
            <div class="text-muted small">
              No suggestions yet. Try quick tweaks:
              <code>x+1</code>, <code>2*x</code>, <code>x**2</code>, <code>sin(x)</code>.
            </div>`;
          return;
        }

        list.forEach((sug) => {
          const chip = document.createElement('button');
          chip.type = 'button';
          chip.className = 'reco-chip';
          chip.title = sug.why || '';
          chip.textContent = sug.label ? `${sug.label} • ${sug.expr}` : sug.expr;
          chip.addEventListener('click', () => {
            expr.value  = sug.expr || expr.value;
            xmin.value  = (sug.xmin ?? xmin.value);
            xmax.value  = (sug.xmax ?? xmax.value);
            if (!title.value && sug.label) title.value = sug.label;
            updateChart();
          });
          recoChips.appendChild(chip);
        });

        const reasons = list.map(s => `• <strong>${s.expr}</strong>: ${escapeHtml(s.why || '')}`).join('<br/>');
        recoWhy.innerHTML = `<div class="reco-note">${reasons}</div>`;
      }

      // Fetch recommendations based on the CURRENT plotted input; DO NOT auto-plot
      async function fetchRecommendations() {
        try {
          setRecoLoading(true);
          const res = await fetch('/recommend', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              expr: expr.value || 'sin(x)',
              xmin: parseFloat(xmin.value || '-10'),
              xmax: parseFloat(xmax.value || '10'),
              title: title.value || ''
            })
          });
          const payload = await res.json();
          renderRecommendations(payload.suggestions || []);
        } catch (err) {
          renderRecommendations([]);
        } finally {
          setRecoLoading(false);
        }
      }

      // Initial empty-state in "Try next"
      renderRecommendations([]);

    </script>
  </body>
</html>
